<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="author" content="Michael Yagi">
        <style>
            #earth_div {
                position:absolute !important;
                top:0;
                right:0;
                bottom:0;
                left:0;
                background:#000 url(stars.jpg);
                background-size:cover;
                touch-action:none;
            }
        </style>
        <script src="webglearth.min.js"></script>
        <script type="text/javascript">
            const baseUrl = "<shashin_url>";
            const apiKey = "<shashin_api_key>";

            let earth;
            let query = "";
            let currMarkers = {};
            let animateRequest;
            let data = {};

            function setQuery(aQuery, currCoordinates, radius, earth, WE) {
                query = aQuery;
                clearMarkers(earth);
                getShashin(currCoordinates,radius,earth,WE);
            }

            function initialize() {
                earth = new WE.map('earth_div',{
                    'atmosphere': true,
                    'sky': false,
                    'position': [0, 0],
                    'panning': true,
                    'tilting': true,
                    'zooming': true
                });
                let currCoordinates = [49.24966, -123.11934];
                earth.setView(currCoordinates, 3);
                const radius = 10000;

                const urlParams = new URLSearchParams(window.location.search);
                let view = urlParams.get('view');
                if (view === null || (view !== "street" && view !== "satellite" && view !== "sat")) {
                    view = "street";
                }

                let mapOptions = {
                    attribution: 'Â© OpenStreetMap contributors',
                    tileSize: 512,
                    zoomOffset: -1
                };
                let tile = "https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=YlQvLcNKq0a4aFDX2z3O";
                if (view === "satellite" || view === "sat") {
                    tile = "https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.jpg?key=YlQvLcNKq0a4aFDX2z3O"; //https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=YlQvLcNKq0a4aFDX2z3O    
                }

                WE.tileLayer(tile, mapOptions).addTo(earth);

                getShashin();
                const d = new Date();
                let n = d.getMilliseconds();
                let before = n;

                function animate(now) {
                    // Array of lat/long
                    const c = earth.getPosition();

                    const elapsed = before ? now - before : 0;
                    before = now;

                    if (getHaversine(c[0],c[1],currCoordinates[0],currCoordinates[1]) > 9000) {
                        currCoordinates = c;
                        getShashin(c,radius,earth,WE);
                    }

                    earth.setCenter([c[0], c[1] - 0.1*(elapsed/30)]);
                    animateRequest = requestAnimationFrame(animate);
                }

                function start() {
                    if (!animateRequest) {
                        const d = new Date();
                        let n = d.getMilliseconds();
                        if (null != before) {
                            before = null;
                            n = before;
                        }

                        animate(n);
                    }
                }

                function stop() {
                    if (animateRequest) {
                        window.cancelAnimationFrame(animateRequest);
                        animateRequest = undefined;
                    }
                }

                document.getElementById("searchForm").addEventListener("submit", function(event) {
                    event.preventDefault();
                    setQuery(document.getElementById("query").value, currCoordinates, radius, earth, WE);
                },false);

                document.getElementById("rotateToggle").addEventListener("click", function(event) {
                    event.preventDefault();

                    if (animateRequest === undefined) {
                        document.getElementById("rotateToggle").textContent = "Stop";
                        start();
                    } else {
                        document.getElementById("rotateToggle").textContent = "Start";
                        stop();
                    }
                },false);

                // Execute after clicking spacebar
                document.body.onkeyup = function(e) {
                    if(e.keyCode == 32){
                        if (animateRequest === undefined) {
                            start();
                        } else {
                            stop();
                        }
                    }
                };
            }

            function getShashin() {
                const urlParams = new URLSearchParams(window.location.search);
                let offset = urlParams.get('offset');
                let limit = urlParams.get('limit');
                let showMarkerImage = urlParams.get('marker');
                let startDate = urlParams.get('start');
                let endDate = urlParams.get('end');

                if (startDate === null || startDate === "" || endDate === null || endDate === "") {
                    startDate = "";
                    endDate = "";
                } else if (startDate === null || startDate === "" && (endDate !== null & endDate !== "")) {
                    console.log("Error: An end date must be set");
                } else if (endDate === null || endDate === "" && (startDate !== null & startDate !== "")) {
                    console.log("Error: A start date must be set");
                }
                if (offset === null) {
                    offset = 0;
                }
                if (limit === null) {
                    limit = 500;
                }
                if (showMarkerImage === null) {
                    showMarkerImage = true;
                } else if (showMarkerImage === 'false') {
                    showMarkerImage = false;
                } else if (showMarkerImage === 'true') {
                    showMarkerImage = true;
                } else {
                    showMarkerImage = true;
                }

                clearMarkers(earth);

                const url = baseUrl+"/api/v1/mapdata/keywords";
                const params = {
                    offset:offset,
                    limit:limit,
                    startDate:startDate,
                    endDate:endDate
                };

                apiRequest(url,"POST",apiKey,JSON.stringify(params),function(response) {
                    console.log(response);
                    data = response;

                    if (data.hasOwnProperty("mapdata") && data.hasOwnProperty("keywordMap")) {
                        const mapdata = data["mapdata"];
                        const keywordMap = data["keywordMap"];

                        for (let i = 0; i < mapdata.length; i++) {
                            const metadata = mapdata[i];

                            if (metadata["lat"] != null && metadata["lng"] != null) {
                                marker = null;
                                if (showMarkerImage === true) {
                                    marker = WE.marker([metadata["lat"], metadata["lng"]], baseUrl+escape(metadata["mapMarkerUrl"]), 30, 30);
                                } else {
                                    marker = WE.marker([metadata["lat"], metadata["lng"]], null, 25, 41);
                                }
                                if (false === currMarkers.hasOwnProperty(metadata["id"])) {
                                    marker["id"] = metadata["id"];

                                    currMarkers[metadata["id"]] = marker;
                                    let markerContent = '<img src="' + baseUrl+escape(metadata["thumbnailUrlSmall"]) + '" height="100" "><br>';
                                    const takenDate = new Date(metadata["year"] + "-" + metadata["month"] + "-" + metadata["day"]);
                                    const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
                                    
                                    markerContent += takenDate.toLocaleDateString('en-us', options) + "<br><br>";
                                    let placeNameStr = "";
                                    let placeType = "";
                                    let placeNameRaw = "";
                                    if (metadata["placeName"] !== null && metadata["placeName"].length > 0) {
                                        placeNameStr = metadata["placeName"];
                                        placeNameRaw = placeNameStr;
                                        const placeArr = placeNameStr.split(";");

                                        if (placeArr.length > 1) {
                                            placeNameStr = placeArr[0];
                                            placeType = placeArr[1];
                                        }

                                        markerContent += placeNameStr;

                                        if (placeType.length > 0) {
                                            markerContent += "<br>" + placeType;
                                        }

                                        markerContent += "<br><br>";
                                    }

                                    let keywordListStr = "";
                                    if (keywordMap.hasOwnProperty(metadata["id"])) {
                                        const keywordList = keywordMap[metadata["id"]];
                                        if (keywordList.length > 0) {
                                            keywordListStr = keywordList.join(", ");
                                            if (keywordListStr !== "unidentified objects") {
                                                markerContent += "Keywords: " + keywordListStr + "<br><br>";
                                            }
                                        }
                                    }

                                    const viewerUrl = (metadata["type"].indexOf("video") > -1) ? baseUrl + "/video/" + metadata["id"] + "/player" : baseUrl + "/image/" + metadata["id"] + "/viewer";
                                    if (metadata["type"].indexOf("video") > -1) {
                                        markerContent += "<a href='" + viewerUrl + "' target='_blank'>Video link</a>";
                                    } else {
                                        markerContent += "<a href='" + viewerUrl + "' target='_blank'>Image link</a>";
                                    }

                                    if (query !== "" &&
                                        placeNameRaw.toLowerCase().indexOf(query.toLowerCase()) === -1 &&
                                        keywordListStr.toLowerCase().indexOf(query.toLowerCase()) === -1 &&
                                        markerContent.toLowerCase().indexOf(query.toLowerCase()) === -1 &&
                                        metadata["id"].toLowerCase().indexOf(query.toLowerCase()) === -1 &&
                                        metadata["thumbnailUrlSmall"].toLowerCase().indexOf(query.toLowerCase()) === -1
                                    ) {
                                        continue;
                                    }

                                    marker.addTo(earth);
                                    marker.bindPopup(markerContent);
                                }
                            }
                        }
                    }
                });
            }

            function apiRequest(url,action,apiKey,params,callback) {
                const xhttp = new XMLHttpRequest();
                xhttp.timeout = 5000; // time in milliseconds
                xhttp.open(action, url, true);
                xhttp.setRequestHeader("Content-type", "application/json");
                xhttp.setRequestHeader("X-Api-Key", apiKey);
                xhttp.onreadystatechange = function() {
                    if (xhttp.readyState === 4 && xhttp.status === 200) {
                        const respObj = JSON.parse(xhttp.responseText);
                        callback(respObj);
                    } else {
                        console.log("Error: "+xhttp.responseText)
                    }
                };
                xhttp.ontimeout = function () {
                    // Do nothing on timeout
                };
                if (params === null) {
                    xhttp.send();
                } else {
                    xhttp.send(params);
                }

            }

            function getHaversine(lat1,lon1,lat2,lon2) {
                const R = 6371; // Radius of the earth in km
                const dLat = (lat2 - lat1) * (Math.PI / 180);  // deg2rad below
                const dLon = (lon2 - lon1) * (Math.PI / 180);
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2)
                ;
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function clearMarkers(earth) {
                for (const id in currMarkers) {
                    if (currMarkers.hasOwnProperty(id)) {
                        const marker = currMarkers[id];
                        marker.removeFrom(earth);
                    }
                }
                currMarkers = {};
            }
        </script>
        <style>
            html, body{padding: 0; margin: 0;}
            #earth_div{ top: 0; right: 0; bottom: 0; left: 0; z-index: 0; position: absolute !important;}
            #inputs {position: absolute; top:10px; left: 10px; z-index: 1;}
        </style>
        <title>EarthFeed</title>
    </head>
    <body onload="initialize()">
        <div id="inputs">
            <form id="searchForm">
                <input title="Search Query" type="text" id="query" name="query" value='' placeholder="Search images">
                <input type="submit">
                <button id="rotateToggle"><span id="rotateText">Start</span></button>
            </form>
        </div>
        <div id="earth_div"></div>
    </body>
</html>
